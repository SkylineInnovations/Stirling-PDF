<!DOCTYPE html>
<html th:lang="${#locale.language}" th:dir="#{language.direction}" th:data-language="${#locale.toString()}"
  xmlns:th="https://www.thymeleaf.org">

<head>
  <th:block th:insert="~{fragments/common :: head(title='')}"></th:block>
</head>

<body>
  <div id="page-container">
    <div id="content-wrap">
      <th:block th:insert="~{fragments/navbar.html :: navbar}"></th:block>

        <div class="container">
        <div style="display:flex; gap:3rem">
 <!-- Jumbotron -->
 <div class="rounded d-none d-md-block" id="jumbotron">
         <h1 class="display-4 fw-normal" th:text="${@appName}"></h1>
          <p class="lead fs-4"
            th:text="${@homeText != 'null' and @homeText != null and @homeText != ''} ? ${@homeText} : #{home.desc}">
          </p>
        </div>
        <div id="groupRecent" >
          <div th:replace="~{fragments/featureGroupHeader :: featureGroupHeader(groupTitle=#{navbar.recent})}">
          </div>
          <div style="display: flex; flex-direction: row;">
            <div class="newfeature"
  th:include="~{fragments/navbarEntry :: navbarEntry('redact', 'playlist_remove', 'home.redact.title', 'home.redact.desc', 'redact.tags', 'security')}">
</div>
<div class="newfeature"
th:include="~{fragments/navbarEntry :: navbarEntry ('multi-tool', 'construction', 'home.multiTool.title', 'home.multiTool.desc', 'multiTool.tags', 'organize')}">
</div>
<div class="newfeature"
th:include="~{fragments/navbarEntry :: navbarEntry('validate-signature', 'verified', 'home.validateSignature.title', 'home.validateSignature.desc', 'validateSignature.tags', 'security')}">
</div>
          </div>
        </div>
      </div>

      </div>


      <br class="d-md-none">
      <!-- Features -->
      <script th:src="@{'/js/homecard.js'}"></script>
      <div style="
      width: 100%;
      display: flex;
      flex-direction: column;">
          <div>
        <br>
        <div style="justify-content: center; display: flex;">
          <div style="width:80%">
          <span class="material-symbols-rounded search-icon">
            search
          </span>
        <input type="text" id="searchBar" onkeyup="filterCards()" th:placeholder="#{home.searchBar}" autofocus>

        <div style="display: flex; justify-content: center;">
        <div  style="display: flex; align-items: center; flex-wrap: wrap; align-content: flex-start; width: fit-content; max-width: 100%; gap:3rem">
          <div  style="display: flex; align-items: center; cursor: pointer;" onclick="toggleFavoritesMode()" >
          <span th:text="#{home.setFavorites}">Hide Favourites</span>
        <span class="material-symbols-rounded toggle-favourites" style="font-size: 2rem;  margin-left: 0.2rem;" >
          star
        </span>
        </div>
        <div onclick="toggleFavoritesView()" id="favouritesVisibility" style="display: flex; align-items: center; cursor: pointer;">
          <span     id="toggle-favourites-text"
          th:text="#{home.hideFavorites}">Hide Favourites</span>
        <span     id="toggle-favourites-icon" class="material-symbols-rounded toggle-favourites"  style="font-size: 2rem;  margin-left: 0.2rem;" >
          visibility
        </span>
        </div>
        <a href="home" onclick="setAsDefault('home-legacy')" style="text-decoration: none; color: inherit; cursor: pointer; display: flex; align-items: center;">
          <span th:text="#{home.legacyHomepage}">
          </span>
        <span class="material-symbols-rounded toggle-favourites"  style="font-size: 2rem; margin-left: 0.2rem;" >
          home
        </span>
        </a>
        <div style="height:2.5rem;  display: flex; align-items: center; cursor: pointer;">
          <label for="sort-options">Sort by:</label>
          <select id="sort-options" style="border:none">
            <option value="alphabetical"  th:text="#{home.alphabetical}"> </option>
            <!-- <option value="personal">Your most used</option> -->
            <option value="global" th:text="#{home.globalPopularity}"></option>
            <!-- <option value="server">Popularity in organisation</option> -->
          </select>
        </div>
      </div>

      </div>
      </div>
      </div>
        </div>
        <div>
        </div>
        <div class="features-container">
          <div th:if="${@shouldShow}" class="feature-card favorite update-notice" id="update-link"
            style="display: none;">
            <a href="https://github.com/Stirling-Tools/Stirling-PDF/releases" target="_blank" rel="noopener">
              <div class="d-flex align-items-center">
                <div id="tool-icon" class="advance" alt="icon">
                  <span class="material-symbols-rounded nav-icon">update</span>
                </div>
                <div id="tool-text">
                  <h5 class="card-title" th:text="#{settings.update}"></h5>
                  <p class="card-text" id="app-update"></p>
                </div>
              </div>
            </a>
          </div>
          <div class="feature-rows">
            <div id="groupFavorites" class="feature-group">
              <div th:replace="~{fragments/featureGroupHeader :: featureGroupHeader(groupTitle=#{navbar.favorite})}">
              </div>
              <div class="nav-group-container">
              </div>
            </div>
          <th:block th:insert="~{fragments/navElements.html :: navElements}"></th:block>
          </div>

        </div>
      </div>
    </div>
    <th:block th:insert="~{fragments/footer.html :: footer}"></th:block>
  </div>


  <!-- Survey Modal -->
  <div class="modal fade" id="surveyModal" tabindex="-1" role="dialog" aria-labelledby="surveyModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="surveyModalLabel" th:text="#{survey.title}">Stirling-PDF Survey</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><span th:text="#{survey.changes}">Stirling-PDF has changed since the last survey! To find out more please
              check our blog post here: </span><a href="https://www.stirlingpdf.com/blog/stirling-pdf-future"
              target="_blank"> Stirling PDF</a></p>

          <p th:text="#{survey.changes2}">With these changes we are getting paid business support and funding</p>
          <p th:text="#{survey.please}">Please consider taking our survey!</p>
          <p th:text="#{survey.disabled}">Survey popup will be disabled in following updates but available at foot of
            page)</p>
          <a href="https://stirlingpdf.info/s/cm28y3niq000o56dv7liv8wsu" target="_blank" class="btn btn-primary"
            id="takeSurvey" th:text="#{survey.button}">Take Survey</a>
        </div>
        <div class="modal-footer">
          <div class="form-check mb-3">
            <input type="checkbox" id="dontShowAgain">
            <label for="dontShowAgain" th:text="#{survey.dontShowAgain}">Don't show again</label>
          </div>

          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" th:text="#{close}">Close</button>

        </div>
      </div>
    </div>
  </div>


  <!-- Analytics Modal -->
  <div class="modal fade" id="analyticsModal" tabindex="-1" role="dialog" aria-labelledby="analyticsModalLabel"
    aria-hidden="true" th:if="${@analyticsPrompt}">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="analyticsModalLabel" th:text="#{analytics.title}">Do you want make Stirling PDF
            better?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p th:text="#{analytics.paragraph1}">Stirling PDF has opt in analytics to help us improve the product. We do
            not track any personal information or file contents.</p>
          <p th:text="#{analytics.paragraph2}">Please consider enabling analytics to help Stirling-PDF grow and to allow
            us to understand our users better.</p>
          <p th:text="#{analytics.settings}">You can change the settings for analytics in the config/settings.yml file
          </p>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="setAnalytics(false)"
            th:text="#{analytics.disable}">Disable analytics</button>
          <button type="button" class="btn btn-primary" th:text="#{analytics.enable}"
            onclick="setAnalytics(true)">Enable analytics</button>
        </div>
      </div>
    </div>
  </div>


<style> .favorite-icon {
  cursor: pointer;
  width:0rem;
  font-size: 2rem;
}
.toggle-favourites{
  cursor: pointer;
}
.toggle-favourites.active {
  color: gold;
}
</style>
  <script th:src="@{'/js/fetch-utils.js'}"></script>
  <script th:inline="javascript">

    /*<![CDATA[*/
    const analyticsPromptBoolean = /*[[${@analyticsPrompt}]]*/ false;

    document.addEventListener('DOMContentLoaded', function () {
      if (analyticsPromptBoolean) {
        const analyticsModal = new bootstrap.Modal(document.getElementById('analyticsModal'));
        analyticsModal.show();
      }
    });
    /*]]>*/
    function setAnalytics(enabled) {
      fetchWithCsrf('api/v1/settings/update-enable-analytics', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(enabled)
      })
        .then(response => {
          if (response.status === 200) {
            console.log('Analytics setting updated successfully');
            bootstrap.Modal.getInstance(document.getElementById('analyticsModal')).hide();
          } else if (response.status === 208) {
            console.log('Analytics setting has already been set. Please edit /config/settings.yml to change it.', response);
            alert('Analytics setting has already been set. Please edit /config/settings.yml to change it.');
          } else {
            throw new Error('Unexpected response status: ' + response.status);
          }
        })
        .catch(error => {
          console.error('Error updating analytics setting:', error);
          alert('An error occurred while updating the analytics setting. Please try again.');
        });
    }


updateFavoriteIcons();



// function updateFavoritesDropdown() {
//   const favoritesList = JSON.parse(localStorage.getItem('favoritesList')) || [];
//   const favoritesDropdown = document.getElementById('favoritesDropdown');
//   favoritesDropdown.innerHTML = '';
//   favoritesList.forEach(fav => {
//     const item = document.createElement('div');
//     item.textContent = fav;
//     favoritesDropdown.appendChild(item);
//   });
// }


    const defaultView = localStorage.getItem("defaultView") || "home"; // Default to "home"
    if (defaultView === "home-legacy") {
      window.location.href = "/home-legacy"; // Redirect to legacy view
    }



    document.addEventListener("DOMContentLoaded", function () {

      const surveyVersion = "2.0";
      const modal = new bootstrap.Modal(document.getElementById('surveyModal'));
      const dontShowAgain = document.getElementById('dontShowAgain');
      const takeSurveyButton = document.getElementById('takeSurvey');

      const viewThresholds = [5, 10, 15, 22, 30, 50, 75, 100, 150, 200];

      // Check if survey version changed and reset page views if it did
      const storedVersion = localStorage.getItem('surveyVersion');
      if (storedVersion && storedVersion !== surveyVersion) {
        localStorage.setItem('pageViews', '0');
      }

      let pageViews = parseInt(localStorage.getItem('pageViews') || '0');

      pageViews++;
      localStorage.setItem('pageViews', pageViews.toString());

      function shouldShowSurvey() {
        if (localStorage.getItem('dontShowSurvey') === 'true' ||
          localStorage.getItem('surveyTaken') === 'true') {
          return false;
        }

        // If survey version changed and we hit a threshold, show the survey
        if (localStorage.getItem('surveyVersion') !== surveyVersion &&
          viewThresholds.includes(pageViews)) {
          return true;
        }

        return viewThresholds.includes(pageViews);
      }

      if (shouldShowSurvey()) {
        modal.show();
      }

      dontShowAgain.addEventListener('change', function () {
        if (this.checked) {
          localStorage.setItem('dontShowSurvey', 'true');
          localStorage.setItem('surveyVersion', surveyVersion);
        } else {
          localStorage.removeItem('dontShowSurvey');
          localStorage.removeItem('surveyVersion');
        }
      });

      takeSurveyButton.addEventListener('click', function () {
        localStorage.setItem('surveyTaken', 'true');
        localStorage.setItem('surveyVersion', surveyVersion);
        modal.hide();
      });

      if (localStorage.getItem('dontShowSurvey')) {
        modal.hide();
      }

    if (window.location.pathname === '/') {
      const navItem = document.getElementById('navItemToHide');
      if (navItem) {
        navItem.style.display = 'none'
      }
    }
    updateFavoritesDropdown();

  });
  function setAsDefault(value) {
      localStorage.setItem('defaultView', value);
      console.log(`Default view set to: ${value}`);
      }
  </script>


</body>

</html>